{% extends "base.html" %}

{% block title %}{{ course.name }} - Chatbot{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="flex items-center justify-between px-4 py-4">
            <div class="flex items-center gap-4">
                <a href="/courses" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-lg font-semibold text-gray-900">{{ course.name }}</h1>
                    <p class="text-sm text-gray-500">{{ course.code }} â€¢ {{ course.instructor }}</p>
                </div>
            </div>
            <form method="POST" action="/logout">
                <button type="submit" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                    Logout
                </button>
            </form>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- Course Info Card -->
        <div class="{{ course.color }} rounded-lg p-6 mb-6 text-white">
            <div class="flex items-start justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Course Assistant</h2>
                    <p class="text-white/90">Ask me anything about {{ course.name }}</p>
                </div>
                <svg class="h-12 w-12 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                </svg>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Sidebar - Course Management -->
            <div class="lg:col-span-1 space-y-4">
                
                {% if user_type == 'instructor' %}
                <!-- Instructor Control Panel -->
                <div class="bg-white rounded-lg shadow border border-gray-200 p-4 sticky top-24">
                    <h3 class="font-semibold text-gray-900 mb-4">Instructor Panel</h3>
                    <div class="space-y-3">
                        <a href="/course/{{ course.id }}/documents" class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 text-left transition-colors">
                            <svg class="w-6 h-6 text-[#003366]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span class="text-sm font-medium text-gray-800">Manage Materials</span>
                        </a>
                        <button onclick="editObjectives()" class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 text-left transition-colors">
                            <svg class="w-6 h-6 text-[#003366]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            <span class="text-sm font-medium text-gray-800">Edit Objectives</span>
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- Student View: Course Links -->
                <div class="bg-white rounded-lg shadow border border-gray-200 p-4 sticky top-24">
                    <h3 class="font-semibold text-gray-900 mb-4">Course Tools</h3>
                    <div class="space-y-3">
                        <a href="/course/{{ course.id }}/history" class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 text-left transition-colors">
                            <svg class="w-6 h-6 text-[#003366]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="text-sm font-medium text-gray-800">My Chat History</span>
                        </a>
                        <div id="materialsList" class="space-y-2 pt-2">
                            <h4 class="font-medium text-gray-800 text-sm px-3">Course Materials</h4>
                            <div id="materialsContent" class="max-h-60 overflow-y-auto">
                                <div class="text-sm text-gray-500 px-3">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Course Objectives (Modal for Instructor) -->
                {% if user_type == 'instructor' %}
                <div id="objectivesModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                        <div class="flex items-center justify-between p-4 border-b">
                            <h3 class="font-semibold">Edit Course Objectives</h3>
                            <button onclick="cancelEditObjectives()" class="text-gray-500 hover:text-gray-700">&times;</button>
                        </div>
                        <div class="p-4">
                            <textarea id="objectivesInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="8">{{ objectives }}</textarea>
                        </div>
                        <div class="flex justify-end gap-2 p-4 border-t">
                            <button onclick="cancelEditObjectives()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">Cancel</button>
                            <button onclick="saveObjectives()" class="bg-[#003366] text-white px-4 py-2 rounded-lg text-sm">Save</button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Main Chat Area -->
                        <!-- Main Chat Area -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex flex-col" style="height: 75vh;">
                    <!-- Persona Selector -->
                    <div class="bg-gray-50 border-b border-gray-200 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assistant Mode:</label>
                                <select id="persona-select" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#003366] focus:border-transparent text-sm">
                                    <option value="default">Default</option>
                                    {% for name, config in persona_configs.items() %}
                                        {% if config.enabled %}
                                            <option value="{{ name }}">{{ name.title() }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            {% if user_type == 'instructor' %}
                            <a href="/persona-config" class="text-sm text-[#003366] hover:underline font-medium">Configure Personas</a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Chat History Display -->
                    <div id="chat-history" class="flex-1 p-6 space-y-6 overflow-y-auto">
                        {% for message in chat_history %}
                            {% if message.role == 'user' %}
                            <div class="flex items-start gap-3 justify-end">
                                <div class="bg-blue-600 text-white p-3 rounded-lg max-w-xl">
                                    <p class="text-sm">{{ message.content }}</p>
                                </div>
                            </div>
                            {% elif message.role == 'assistant' %}
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center font-semibold text-white text-sm flex-shrink-0">AI</div>
                                <div class="bg-white border border-gray-200 p-3 rounded-lg max-w-xl prose prose-sm">
                                    {{ message.content | markdown_to_html | safe }}
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="text-center text-gray-500 py-8 h-full flex flex-col justify-center items-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Start a conversation</h3>
                            <p class="mt-1 text-sm text-gray-500">Ask a question about {{ course.name }} to get started.</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white border-t border-gray-200 p-4">
                        <form id="chat-form" class="relative">
                            <textarea id="chat-input" placeholder="Ask a question..." class="w-full pl-4 pr-36 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm resize-none" rows="1"></textarea>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                                <div class="flex items-center gap-2 border-r pr-2">
                                    <input type="checkbox" id="rag-toggle" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500" checked>
                                    <label for="rag-toggle" class="text-xs text-gray-600 font-medium">Search Materials</label>
                                </div>
                                <button id="send-btn" type="submit" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 disabled:bg-blue-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatHistory = document.getElementById('chat-history');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const ragToggle = document.getElementById('rag-toggle');
    const personaSelect = document.getElementById('persona-select');

    const courseId = {{ course.id }};
    const sessionId = "{{ session_id }}";
    const chatId = "{{ chat_id }}";

    // Auto-scroll to the bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = (chatInput.scrollHeight) + 'px';
    });
     chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.requestSubmit();
        }
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = chatInput.value.trim();
        if (!prompt) return;

        // Clear the "start a conversation" message if it exists
        const emptyState = chatHistory.querySelector('.text-center.text-gray-500');
        if (emptyState) {
            emptyState.parentElement.removeChild(emptyState);
        }

        // Disable form
        chatInput.value = '';
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;
        const originalButtonContent = sendBtn.innerHTML;
        sendBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v.01M12 20v.01M4 12h.01M20 12h.01M6.31 6.31l.01.01M17.69 17.69l.01.01M6.31 17.69l.01-.01M17.69 6.31l.01-.01"></path></svg>';

        // Add user message to UI
        const userMessageEl = document.createElement('div');
        userMessageEl.className = 'flex items-start gap-3 justify-end';
        userMessageEl.innerHTML = `
            <div class="bg-blue-600 text-white p-3 rounded-lg max-w-xl">
                <p class="text-sm">${prompt.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
            </div>
        `;
        chatHistory.appendChild(userMessageEl);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Add placeholder for AI response
        const aiMessageEl = document.createElement('div');
        aiMessageEl.className = 'flex items-start gap-3';
        aiMessageEl.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center font-semibold text-white text-sm flex-shrink-0">AI</div>
            <div class="bg-white border border-gray-200 p-3 rounded-lg max-w-xl prose prose-sm animate-pulse">
                Thinking...
            </div>
        `;
        chatHistory.appendChild(aiMessageEl);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    persona: personaSelect.value,
                    use_rag: ragToggle.checked,
                    course_id: courseId,
                    session_id: sessionId,
                    chat_id: chatId
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            const formattedResponse = marked.parse(data.response);

            const responseContent = aiMessageEl.querySelector('.prose');
            responseContent.innerHTML = formattedResponse;
            responseContent.classList.remove('animate-pulse');

        } catch (error) {
            console.error('Chat error:', error);
            const errorContent = aiMessageEl.querySelector('.prose');
            errorContent.innerHTML = '<p class="text-red-500">Sorry, something went wrong. Please try again.</p>';
            errorContent.classList.remove('animate-pulse');
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalButtonContent;
            chatInput.focus();
        }
    });

    // Enable send button only when there is text
    chatInput.addEventListener('input', () => {
        sendBtn.disabled = chatInput.value.trim().length === 0;
    });
    sendBtn.disabled = true; // Initially disabled

    // Instructor objective editing
    {% if user_type == 'instructor' %}
    window.editObjectives = () => {
        document.getElementById('objectivesModal').classList.remove('hidden');
        document.getElementById('objectivesModal').classList.add('flex');
    }
    window.cancelEditObjectives = () => {
        document.getElementById('objectivesModal').classList.add('hidden');
        document.getElementById('objectivesModal').classList.remove('flex');
    }
    window.saveObjectives = async () => {
        const objectives = document.getElementById('objectivesInput').value;
        const response = await fetch(`/course/${courseId}/objectives`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `objectives=${encodeURIComponent(objectives)}`
        });
        if (response.ok) {
            window.cancelEditObjectives();
            // Maybe show a success message
        } else {
            alert('Failed to save objectives.');
        }
    };
    {% endif %}

    // Fetch and display course materials
    async function fetchMaterials() {
        const container = document.getElementById('materialsContent');
        if (!container) return;

        try {
            const response = await fetch(`/course/${courseId}/materials`);
            const data = await response.json();
            
            if (data.documents && data.documents.length > 0) {
                container.innerHTML = data.documents.map(doc => `
                    <a href="#" class="block text-sm text-gray-700 p-2 rounded-md hover:bg-gray-200">${doc.name}</a>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-sm text-gray-500 px-3">No materials uploaded.</div>';
            }
        } catch (error) {
            console.error('Error fetching materials:', error);
            container.innerHTML = '<div class="text-sm text-red-500 px-3">Error loading materials.</div>';
        }
    }
    fetchMaterials();
});
</script>
{% endblock %}
