{% extends "base.html" %}

{% block title %}Persona Configuration{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="flex items-center justify-between px-4 py-4">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-semibold text-gray-900">Course Dashboard</h1>
            </div>
            <form method="POST" action="/logout">
                <button type="submit" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                    Logout
                </button>
            </form>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-white border-r border-gray-200 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 mt-[65px]">
            <nav class="p-4 space-y-2">
                <a href="/dashboard" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>Dashboard</span>
                </a>
                <a href="/courses" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span>Courses</span>
                </a>
                <a href="/calendar" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Calendar</span>
                </a>
                <a href="/assignments" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Assignments</span>
                </a>
                <a href="/grades" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Grades</span>
                </a>
                {% if request.session.get("user", {}).get("type") == "instructor" %}
                <a href="/persona-config" class="flex items-center gap-3 px-4 py-3 text-gray-900 bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Persona Config</span>
                </a>
                {% endif %}
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-0 w-full">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Persona Configuration</h1>
                        <p class="text-gray-600">Manage the AI personas for your courses.</p>
                    </div>
                    <button id="add-persona-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Add New Persona</button>
                </div>
                
                <div id="persona-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {% for name, config in configs.items() %}
                    <div class="persona-card bg-white shadow-md rounded-lg p-6" data-persona-name="{{ name.title() }}">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">{{ name.title() }}</h2>
                            <label class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" class="persona-enabled sr-only" {% if config.enabled %}checked{% endif %}>
                                    <div class="w-10 h-4 bg-gray-400 rounded-full shadow-inner"></div>
                                    <div class="dot absolute w-6 h-6 bg-white rounded-full shadow -left-1 -top-1 transition"></div>
                                </div>
                            </label>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tone</label>
                                <input type="text" class="persona-tone mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm" value="{{ config.tone }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Detail Level</label>
                                <input type="range" class="persona-detail w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="5" value="{{ config.detail }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Behavior Rules</label>
                                <textarea class="persona-rules mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows="3">{{ config.rules }}</textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-8 text-right">
                    <button id="save-btn" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden hidden" onclick="toggleSidebar()"></div>
</div>

<template id="persona-card-template">
    <div class="persona-card bg-white shadow-md rounded-lg p-6" data-persona-name="">
        <div class="flex justify-between items-center mb-4">
            <input type="text" class="persona-name-input text-2xl font-semibold text-gray-700 border-b-2 border-gray-300 focus:border-blue-500 outline-none" placeholder="Persona Name">
            <label class="flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" class="persona-enabled sr-only" checked>
                    <div class="w-10 h-4 bg-gray-400 rounded-full shadow-inner"></div>
                    <div class="dot absolute w-6 h-6 bg-white rounded-full shadow -left-1 -top-1 transition"></div>
                </div>
            </label>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Tone</label>
                <input type="text" class="persona-tone mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm" value="Neutral">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Detail Level</label>
                <input type="range" class="persona-detail w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="5" value="3">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Behavior Rules</label>
                <textarea class="persona-rules mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows="3" placeholder="e.g., Be brief and to the point."></textarea>
            </div>
        </div>
    </div>
</template>

<style>
    input:checked ~ .dot {
        transform: translateX(100%);
        background-color: #4f46e5;
    }
    input:checked ~ .w-10 {
        background-color: #a5b4fc;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const saveBtn = document.getElementById('save-btn');
    const personaGrid = document.getElementById('persona-grid');
    const addPersonaBtn = document.getElementById('add-persona-btn');
    const personaCardTemplate = document.getElementById('persona-card-template');

    function initializeCard(card) {
        const toggle = card.querySelector('.persona-enabled');
        const fields = card.querySelectorAll('input[type=text], input[type=range], textarea');
        const labels = card.querySelectorAll('.space-y-4 label');

        function updateState() {
            if (toggle.checked) {
                fields.forEach(field => field.disabled = false);
                labels.forEach(label => label.classList.remove('text-gray-400'));
                card.querySelector('.space-y-4').classList.remove('text-gray-400');
            } else {
                fields.forEach(field => field.disabled = true);
                labels.forEach(label => label.classList.add('text-gray-400'));
                card.querySelector('.space-y-4').classList.add('text-gray-400');
            }
        }

        toggle.addEventListener('change', updateState);
        updateState(); // Set initial state
    }

    // Initialize existing cards
    document.querySelectorAll('.persona-card').forEach(initializeCard);

    addPersonaBtn.addEventListener('click', () => {
        const newCard = personaCardTemplate.content.cloneNode(true).firstElementChild;
        personaGrid.appendChild(newCard);
        initializeCard(newCard);
        newCard.querySelector('.persona-name-input').focus();
    });

    saveBtn.addEventListener('click', async () => {
        const personaCards = document.querySelectorAll('.persona-card');
        const configs = [];
        let hasError = false;

        personaCards.forEach(card => {
            const nameInput = card.querySelector('.persona-name-input');
            let name = card.dataset.personaName;
            if (nameInput) { // It's a new card
                name = nameInput.value.trim();
                if (!name) {
                    nameInput.classList.add('border-red-500');
                    hasError = true;
                } else {
                    nameInput.classList.remove('border-red-500');
                }
            }

            if (name) {
                const enabled = card.querySelector('.persona-enabled').checked;
                const tone = card.querySelector('.persona-tone').value;
                const detail = parseInt(card.querySelector('.persona-detail').value, 10);
                const rules = card.querySelector('.persona-rules').value;
                configs.push({ name, enabled, tone, detail, rules });
            }
        });

        if (hasError) {
            alert('Please provide a name for all new personas.');
            return;
        }

        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        try {
            const response = await fetch('/persona-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ configs }),
            });

            if (response.ok) {
                saveBtn.textContent = 'Saved!';
                setTimeout(() => {
                    saveBtn.textContent = 'Save Changes';
                    saveBtn.disabled = false;
                    // Optional: Reload or update UI to reflect saved state
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error('Failed to save');
            }
        } catch (error) {
            console.error('Error saving persona configs:', error);
            saveBtn.textContent = 'Error!';
            setTimeout(() => {
                saveBtn.textContent = 'Save Changes';
                saveBtn.disabled = false;
            }, 3000);
        }
    });
});
</script>
{% endblock %}
